name: Build OpenFi 6C with QModem & Luci-App-OpenFi

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. Checkout репозитория
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Установка зависимостей сборки
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential flex bison gawk \
            libncurses5-dev libssl-dev python3-distutils git unzip wget rsync

      # 3. Обновление feeds
      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. Установка конкретных пакетов
       #         ./scripts/feeds install qmodem
      - name: Install QModem and Luci-App-OpenFi
        run: |

          ./scripts/feeds install luci-app-openfi

      # 5. Подгрузка дефолтной конфигурации OpenFi 6C
      - name: Load OpenFi 6C defconfig
        run: |
          cp defconfig/mt7981-ax3000-openfi6c1.config .config
          make defconfig


#          scripts/feeds/conf --enable qmodem
          
#          scripts/feeds/conf --enable luci-app-qmodem
#          scripts/feeds/conf --enable luci-app-qmodem-ttl
#          scripts/feeds/conf --enable luci-app-qmodem-sms
#          scripts/feeds/conf --enable luci-app-qmodem-mwan     
      # 6. Автоматическое включение пакетов в .config
      - name: Enable packages in config
        run: |
          scripts/feeds/conf --enable luci-app-openfi
      - name: Fix mediatek kernel version
        run: |
          sed -i 's/KERNEL_PATCHVER := .*/KERNEL_PATCHVER := 6.6/' feeds/openfi6c/target/linux/mediatek/Makefile
      - name: Generate default config    
        run: make defconfig
          
      - name: Debug target feed errors
        if: failure() || always()
        run: |
          find logs/ -type f -name "*.txt" -exec echo "===== {} =====" \; -exec cat {} \;    

      # 7. Сборка прошивки
      - name: Build firmware
        run: |
